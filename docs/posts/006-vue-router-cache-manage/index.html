<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Vue Router] vue router 캐시 관리</title>
    <meta name="description" content="I am writing about my experiences as a naval navel-gazer.">
    <link rel="stylesheet" href="/techblog/css/index.css">
    <link rel="stylesheet" href="/techblog/css/prism-base16-monokai.dark.css">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/techblog/">my techblog</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/techblog/">Home</a></li>
        <li class="nav-item"><a href="/techblog/posts/">Archive</a></li>
        <li class="nav-item"><a href="/techblog/about/">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>[Vue Router] vue router 캐시 관리</h1>

<time datetime="2021-09-27">27 Sep 2021</time><a href="/techblog/tags/vue.js/" class="post-tag">Vue.js</a><a href="/techblog/tags/vue.js@3/" class="post-tag">Vue.js@3</a><a href="/techblog/tags/vue-router/" class="post-tag">Vue Router</a><a href="/techblog/tags/vue-router@next/" class="post-tag">Vue Router@next</a>

<h2 id="(%EC%9E%91%EC%84%B1%EC%A4%91)">(작성중) <a class="direct-link" href="#(%EC%9E%91%EC%84%B1%EC%A4%91)">#</a></h2>
<h1 id="vue-router-%EC%BA%90%EC%8B%9C-%EA%B4%80%EB%A6%AC">vue router 캐시 관리 <a class="direct-link" href="#vue-router-%EC%BA%90%EC%8B%9C-%EA%B4%80%EB%A6%AC">#</a></h1>
<h2 id="%EC%83%81%ED%99%A9">상황 <a class="direct-link" href="#%EC%83%81%ED%99%A9">#</a></h2>
<ul>
<li>Vue.js 3, Vue-router next 사용중</li>
<li>탭으로 여러 화면을 동시에 관리할 수 있도록 화면 구성 중</li>
<li>탭으로 띄운 화면을 종료하는 경우, 다시 켰을 때 탭의 데이터가 남아 있음
<ul>
<li>같은 화면으로 메뉴 ID에 따라 여러 화면을 처리하는데, 구분값이 query에 있어, 기본 router-view의 키로는 구분이 불가능</li>
</ul>
</li>
</ul>
<h3 id="%EA%B8%B0%EB%B3%B8%EC%A0%81%EC%9D%B8-%EA%B5%AC%EC%A1%B0">기본적인 구조 <a class="direct-link" href="#%EA%B8%B0%EB%B3%B8%EC%A0%81%EC%9D%B8-%EA%B5%AC%EC%A1%B0">#</a></h3>
<ul>
<li>App.vue
<ul>
<li>Login.vue: 로그인 때 작동</li>
<li>Main.vue: 로그인 후 등 인증정보가 있을 때 작동
<ul>
<li>메뉴 등 공통 화면</li>
<li>Vue Router의 router-view로 querystring의 파라미터에 따라 서버로부터 해당하는 값을 가져와 화면을 렌더링</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="%EC%B2%98%EB%A6%AC">처리 <a class="direct-link" href="#%EC%B2%98%EB%A6%AC">#</a></h2>
<h3 id="1.-keep-alive%EB%A5%BC-%EC%A3%BC%EC%96%B4-%EC%9E%91%EC%97%85%EC%A4%91%EC%9D%B8-%ED%99%94%EB%A9%B4%EC%9D%84-(%EC%A2%85%EB%A3%8C%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%80-%EA%B2%BD%EC%9A%B0%EC%97%90%EB%8A%94)-%EC%9C%A0%EC%A7%80%ED%95%A0%EC%88%98-%EC%9E%88%EB%8F%84%EB%A1%9D-%EC%BA%90%EC%8B%9C-%EC%B2%98%EB%A6%AC%ED%95%9C%EB%8B%A4.">1. keep-alive를 주어 작업중인 화면을 (종료하지 않은 경우에는) 유지할수 있도록 캐시 처리한다. <a class="direct-link" href="#1.-keep-alive%EB%A5%BC-%EC%A3%BC%EC%96%B4-%EC%9E%91%EC%97%85%EC%A4%91%EC%9D%B8-%ED%99%94%EB%A9%B4%EC%9D%84-(%EC%A2%85%EB%A3%8C%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%80-%EA%B2%BD%EC%9A%B0%EC%97%90%EB%8A%94)-%EC%9C%A0%EC%A7%80%ED%95%A0%EC%88%98-%EC%9E%88%EB%8F%84%EB%A1%9D-%EC%BA%90%EC%8B%9C-%EC%B2%98%EB%A6%AC%ED%95%9C%EB%8B%A4.">#</a></h3>
<ul>
<li><a href="https://next.router.vuejs.org/guide/migration/#router-view-keep-alive-and-transition">참고-Vue Router</a></li>
<li>작업 시, 활성화중인 URL(탭)로 접근하면 기존 탭이 활성화된다.(캐싱중인 화면 조회)</li>
</ul>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span> <span class="token attr-name">v-slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{ Component }<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Component<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">></span></span></code></pre>
<h3 id="(2.-query%EC%9D%98-%EA%B0%92%EB%8F%84-router-view-component%EB%A1%9C-%EC%82%AC%EC%9A%A9%ED%95%A0-%EC%88%98-%EC%9E%88%EB%8F%84%EB%A1%9D-%EC%BB%A4%EC%8A%A4%ED%84%B0%EB%A7%88%EC%9D%B4%EC%A7%95%EB%90%9C-%ED%82%A4%EA%B0%92%EC%9D%84-%EC%A4%80%EB%8B%A4)">(2. query의 값도 router-view Component로 사용할 수 있도록 커스터마이징된 키값을 준다) <a class="direct-link" href="#(2.-query%EC%9D%98-%EA%B0%92%EB%8F%84-router-view-component%EB%A1%9C-%EC%82%AC%EC%9A%A9%ED%95%A0-%EC%88%98-%EC%9E%88%EB%8F%84%EB%A1%9D-%EC%BB%A4%EC%8A%A4%ED%84%B0%EB%A7%88%EC%9D%B4%EC%A7%95%EB%90%9C-%ED%82%A4%EA%B0%92%EC%9D%84-%EC%A4%80%EB%8B%A4)">#</a></h3>
<ul>
<li>v-slot으로 넘어오는 속성인 route 값을 이용하여, path(params)/query/hash 등으로 화면별 고유값인 fullPath를 키로 사용
<ul>
<li>query값이 필요없는 경우 기본값인 key: route.path를 사용해도 됨</li>
<li>
<pre class="language-html"><code class="language-html"></code></pre>
</li>
</ul>
<router-view v-slot="{ Component, route }">
  <keep-alive>
    <component :is="Component" :key="route.fullPath" />
  </keep-alive>
</router-view>
```
</li>
<li>여기까지 작업하면, 탭처리로 컴포넌트는 구분되나, 탭 종료시 화면 정보가 남아있음(다시 화면으로 접근하면 이전 정보가 남아있음)</li>
<li>이는 vue의 keep-alive의 정보를 vue가 직접 관리하기 때문임(개발자가 컨트롤 불가)</li>
</ul>
<h3 id="3.-keep-alive-ref%ED%99%94%ED%95%98%EA%B3%A0%2C-%ED%95%B4%EB%8B%B9-ref%EB%A1%9C-keep-alive-cache%EB%A5%BC-%EC%88%98%EB%8F%99-%EA%B4%80%EB%A6%AC%ED%95%9C%EB%8B%A4">3. keep-alive ref화하고, 해당 ref로 keep alive cache를 수동 관리한다 <a class="direct-link" href="#3.-keep-alive-ref%ED%99%94%ED%95%98%EA%B3%A0%2C-%ED%95%B4%EB%8B%B9-ref%EB%A1%9C-keep-alive-cache%EB%A5%BC-%EC%88%98%EB%8F%99-%EA%B4%80%EB%A6%AC%ED%95%9C%EB%8B%A4">#</a></h3>
<ul>
<li><a href="https://github.com/vuejs/vue-next/issues/2077#issuecomment-887425577">참고</a></li>
</ul>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span> <span class="token attr-name">v-slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{ Component, route }<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>keepAlive<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Component<span class="token punctuation">"</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>route.fullPath<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br><span class="token comment">/**<br> * keepAlive 의 캐시를 수동으로 지우는 함수<br> * 추후 keepAlive의 캐시를 관리하는 기능이 추가될 것으로 보임<br> * https://github.com/vuejs/vue-next/issues/2077#issuecomment-887425577<br> */</span><br><span class="token keyword">const</span> <span class="token function-variable function">__removeKeepAliveCache</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> key<span class="token punctuation">,</span> keepAliveRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> keepAliveInstance <span class="token operator">=</span> keepAliveRef<span class="token punctuation">.</span>$<br>  <span class="token keyword">const</span> cache <span class="token operator">=</span> keepAliveInstance<span class="token punctuation">.</span>__v_cache<br>  <span class="token keyword">const</span> vnode <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><br>  <span class="token comment">// console.log('__removeKeepAliveCache', key, vnode)</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> shapeFlag <span class="token operator">=</span> vnode<span class="token punctuation">.</span>shapeFlag<br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> <span class="token number">256</span> <span class="token comment">/* COMPONENT_SHOULD_KEEP_ALIVE */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      shapeFlag <span class="token operator">-=</span> <span class="token number">256</span> <span class="token comment">/* COMPONENT_SHOULD_KEEP_ALIVE */</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> <span class="token number">512</span> <span class="token comment">/* COMPONENT_KEPT_ALIVE */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      shapeFlag <span class="token operator">-=</span> <span class="token number">512</span> <span class="token comment">/* COMPONENT_KEPT_ALIVE */</span><br>    <span class="token punctuation">}</span><br>    vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">=</span> shapeFlag<br><br>    <span class="token keyword">const</span> renderer <span class="token operator">=</span> keepAliveInstance<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>renderer<br>    renderer<span class="token punctuation">.</span><span class="token function">um</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> keepAliveInstance<span class="token punctuation">,</span> keepAliveInstance<span class="token punctuation">.</span>suspense<span class="token punctuation">)</span><br><br>    cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// console.log('cache', cache)</span><br><span class="token punctuation">}</span><br><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// keep-alive 객체를 관리</span><br>    <span class="token keyword">const</span> keepAlive <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token comment">// 탭이 닫힐 때 이벤트</span><br>    <span class="token keyword">const</span> <span class="token function-variable function">onTabClose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fullPath</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token comment">// after tab closed</span><br>      <span class="token comment">// key에 해당하는 캐시 삭제</span><br>      <span class="token function">__removeKeepAliveCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> fullPath<span class="token punctuation">,</span> keepAliveRef<span class="token operator">:</span> keepAlive <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token punctuation">{</span><br>      keepAlive<br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>

<hr>
<ul><li>Previous: <a href="/techblog/posts/spring-boot-disable-browser-auth-check-popup/">[Spring Boot] 브라우저 인증체크 팝업 비활성화</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /techblog/posts/006-vue-router-cache-manage/ -->
  </body>
</html>
